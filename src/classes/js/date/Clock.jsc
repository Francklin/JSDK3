
$package("js.date");js.date.Clock=function(referTime){this.__timer=null;this.__timeInterval=1000;this._referTime=null;this._referLocalTime=null;this._lastTriggeredTime=null;this._lastFinishedTime=null;this._enabledTrigger=false;this._tasks=[];this._taskInterval=1000*60;this._taskTrigger=null;this._proc=null;this._Clock(referTime);}
var _$class=js.date.Clock;with(_$class){$name="Clock";$extends("Object");prototype._Clock=function(referTime){this._referLocalTime=new Global.js.lang.natives.Date();this._referTime=referTime!=undefined?referTime:this._referLocalTime;this._proc=function(){for(var i=0,iLen=this._tasks.length;i<iLen;i++){var task=this._tasks[i];var date=new Global.js.lang.natives.Date();if(task.isFinished)continue;else if(task.isExpired)continue;if(!(task.date instanceof Array)){date=task.date;}else if(!task.date[1]){date=task.date[0];date.setHours(0);date.setMinutes(0);date.setSeconds(0);date.setMilliseconds(0);}else if(!task.date[0]){date.setHours(task.date[1].getHours());date.setMinutes(task.date[1].getMinutes());date.setSeconds(task.date[1].getSeconds());date.setMilliseconds(task.date[1].getMilliseconds());}else{date=task.date[0];date.setHours(task.date[1].getHours());date.setMinutes(task.date[1].getMinutes());date.setSeconds(task.date[1].getSeconds());date.setMilliseconds(task.date[1].getMilliseconds());}
if((!this._lastFinishedTime||this._lastFinishedTime<date)&&Math.abs(this.getCurrentTime()-date)<1.2*this._taskInterval){this._lastTriggeredTime=this.getCurrentTime();try{task.action.call(task);}catch(e){}
this._lastFinishedTime=this.getCurrentTime();task.isFinished=true;}else if(this._lastTriggeredTime&&this._lastTriggeredTime<=date
&&this._lastFinishedTime&&this._lastFinishedTime>=date){this._lastTriggeredTime=this.getCurrentTime();try{task.action.call(task);}catch(e){}
this._lastFinishedTime=this.getCurrentTime();task.isFinished=true;}else if(this.getCurrentTime()>date){task.isExpired=true;}}}}
addProperty(false,true,"currentTime",{get:function(){var date=new Global.js.lang.natives.Date(this._referTime);var elapseTimes=(new Global.js.lang.natives.Date())-this._referLocalTime;date.setMilliseconds(date.getMilliseconds()+elapseTimes);return date;}});addProperty(false,true,"currentLocalTime",{get:function(){return new Global.js.lang.natives.Date();}});addProperty(false,true,"enabledTrigger",{get:function(){return this._enabledTrigger;},set:function(bValue){var thisObj=this;if(this._enabledTrigger==bValue)return;if(bValue){this._taskTrigger=setInterval(function(){thisObj._proc();},this._taskInterval);}else{clearInterval(this._taskTrigger);}
this._enabledTrigger=bValue;}});addMethod(false,true,"addTask",function(id,vDateTime,vData,fnAction){this._tasks[this._tasks.length]={id:id,date:vDateTime,data:vData,action:fnAction}});addMethod(false,true,"getTask",function(index){return this._tasks[index];});addMethod(false,true,"getTaskById",function(id){for(var i=0,iLen=this._tasks.length;i<iLen;i++){if(this._tasks[i].id==id)return this._tasks[i];}
return null;});addMethod(false,true,"getAllTasks",function(){return this._tasks;});addMethod(false,true,"clearTasks",function(){this._tasks=[];});}
/* @created: Sun Aug 10 22:41:51 UTC+0800 2014*/
{
manifest : {
"name" : "build","file" : "build.json","version" : "0.7","description" : "","author" : "liu denggao"
},
entity : {
"js.build.JSTemplate" : "$package(\"js.build\");js.build.JSTemplate=function(sCode){this._processor;this._subs=[];this._subData=[];this._srcPath=\"\";this._JSTemplate(sCode);};var _$class=js.build.JSTemplate;_$class.$name=\"JSTemplate\";_$class.$extends(\"Object\");var _$proto=_$class.prototype;_$class.newInstanceWithUrl=function(sUrl){var tpl=new this();tpl._JSTemplateFromUrl(sUrl);return tpl;}\n_$proto._JSTemplate=function(sCode){if(!sCode)return;this._JSTemplateFromCode(sCode);}\n_$proto._JSTemplateFromUrl=function(sUrl){this._srcPath=sUrl;this._JSTemplateFromCode(Global.get(sUrl,\"\",false,\"\",\"Text\"));}\n_$proto._JSTemplateFromCode=function(sCode){var codes=[];var strs=Global.obj(sCode).xsplit(\"group\",[\"<%#\",\"%>\",\"<%=\",\"%>\",\"<%\",\"%>\",\"<script>\",\"</script>\",\"<script \",\"></script>\"]);var startOfScript=\"\\t__scripts.push(\";var endOfScript=\");\\n\";for(var i=0,iLen=strs.length;i<iLen;i++){switch(strs[i][0]){case\"<%#%>\":break;case\"<%=%>\":codes.push(startOfScript,strs[i][1],endOfScript);break;case\"<%%>\":codes.push(strs[i][1]);break;case\"<script></script>\":codes.push(startOfScript,Global.obj(strs[i][1]).serialize(),endOfScript);break;case\"<script ></script>\":var attribs=strs[i][1].trim().match(/(src|type|data)=\\\"([^\\\"]+)\\\"/g);if(!attribs)break;attribs.forEach(function(item,index,array){var values=item.match(/^([^\\\"]+)=\\\"([^\\\"]+)\\\"$/)||[null,\"\",\"\"];attribs[values[1]]=values[2];},attribs);if(attribs.src){try{var newFilePath=!this._srcPath?attribs.src:Global.getURIFullPath(this._srcPath.leftBack(\"/\"),attribs.src,\"/\");if(attribs.type!=\"template\"){codes.push(startOfScript,Global.get(newFilePath,\"\",false,\"\",\"Text\").serialize(),endOfScript);}else{var tpl1=this.getClass().newInstanceWithUrl(newFilePath);if(!attribs.data){this._subs.push(tpl1);codes.push(startOfScript,\"this._subs[\\\"\"+(this._subs.length-1)+\"\\\"].parse(json)\",endOfScript);}else if(/\\$\\{[^\\$\\{\\}]*\\}/.test(attribs.data)){this._subs.push(tpl1);codes.push(startOfScript,\"this._subs[\\\"\"+(this._subs.length-1)+\"\\\"].parse(\"+attrib.data.match(/^\\$\\{([^\\$\\{\\}]*)\\}$/).pop()+\")\",endOfScript);}else{try{var data=Global.get(!this._srcPath?attribs.data:Global.getURIFullPath(this._srcPath.leftBack(\"/\"),attribs.data,\"/\"),\"\",false,\"\",\"JSON\");}catch(e){}\nif(data)codes.push(startOfHTML,Global.obj(tpl1.parse(data)).serialize(),endOfHTML);}}}catch(e){}}\nbreak;}}\nthis._processor=new Function(\"json\",\"var __scripts = [];\\n with(json){\"+codes.join(\"\")+'};return __scripts.join(\"\");');}\n_$proto.parse=function(json){return sCode=this._processor(json||{});}",
"js.build.Compressor" : "$package(\"js.build\");js.build.Compressor=function(mode){this._mode=0;this._TERMINATOR_PAT=new RegExp();this._TERMINATOR_PAT.compile(/[\\n\\r\\u2028\\u2029]/);this._LITERALS=[];this._Compressor(mode);}\nvar _$class=js.build.Compressor;_$class.$extends(\"Object\");var _$proto=js.build.Compressor.prototype;_$class.MODE={NONE:0,SAFE:1,FULL:2}\n_$proto._Compressor=function(mode){this._mode=mode;}\n_$proto.getMode=function(){return this._mode;}\n_$proto.compress=function(sCode){var thisObj=this;var ar=sCode.split(\"\");ar.push(\"\\n\");this._parseInputArray(ar);var s=ar.join(\"\");s=s.replace(/[^\\S]/g,function(c){return thisObj._TERMINATOR_PAT.test(c)?\"\\n\":\" \";});s=s.replace(/\\n +/g,\"\\n\");s=s.replace(/([\\n ]){2,}/g,\"$1\");s=s.replace(/^[^\\S]?|[^\\S]?$/g,\"\");if(this._mode!=0){s=s.replace(/([+-])\\n\\1/g,\"$1 $1\");s=s.replace(/([\\u1010{()[\\],<>*%&|^!~?:=.;+-])\\n/g,\"$1\");s=s.replace(/\\n([}:.])/g,\"$1\");if(this._mode==2){s=s.replace(/\\n/g,\" \");}}\ns=this._stripWhitespaces(s);s=s.replace(/\\u1010/g,\"/\");s=this._insertLiterals(s);this._LITERALS.length=0;return s;}\n_$proto._markDeleteElems=function(ar,startPos,endPos){++endPos;for(var i=startPos;i<endPos;++i){ar[i]=null;}}\n_$proto._isStatementStart=function(ar,curPos){while(curPos--){var c=ar[curPos];if(/\\S/.test(c)){return/[(;=]/.test(c);}}\nreturn true;}\n_$proto._parseInputArray=function(ar){var len=ar.length,lenMinusOne=len-1,i=0,c,nextChar,targetChar,startPos,commentType,isEscape;for(;i<len;++i){c=ar[i];if(startPos>-1){if(commentType){if(targetChar==\"*\"){if(i-startPos>2&&ar[i-1]==\"*\"&&c==\"/\"){this._markDeleteElems(ar,startPos,i);startPos=-1;commentType=false;}}else{if(this._TERMINATOR_PAT.test(c)){this._markDeleteElems(ar,startPos,i);startPos=-1;commentType=false;}}}else{if(targetChar==c){if(ar[i-1]==\"\\\\\"){if(i-2&&ar[i-2]==\"\\\\\"){this._pushLiterals(ar,startPos,i);startPos=-1;}}else{this._pushLiterals(ar,startPos,i);startPos=-1;}}}}else{if(i<lenMinusOne){if(c==\"/\"){isEscape=false;for(var j=i-1;j>=0;j--){if(ar[j]=='\\\\')isEscape=(i-j)%2==1;else break;}\nnextChar=ar[i+1];if(!isEscape&&/[*\\/]/.test(nextChar)){startPos=i++;commentType=true;targetChar=nextChar;}else{if(this._isStatementStart(ar,i)){startPos=i;targetChar=c;}else{ar[i]=\"\\u1010\";}}}else{if(/[\"']/.test(c)){targetChar=c;startPos=i;}}}}}}\n_$proto._stripWhitespaces=function(s){s=s.replace(/ ?([\\n\\u1000\\u1010{}()[\\];,<>*%&|^!~?:=]) ?/g,\"$1\");s=s.replace(/([^+]) ?([+])/g,\"$1$2\");s=s.replace(/([+]) ?([^+])/g,\"$1$2\");s=s.replace(/([^-]) ?([-])/g,\"$1$2\");s=s.replace(/([-]) ?([^-])/g,\"$1$2\");return s;}\n_$proto._insertLiterals=function(s){var i=0;var thisObj=this;return s.replace(/\\u1000/g,function(c){return thisObj._LITERALS[i++];});}\n_$proto._convertArrayPortionToString=function(ar,startPos,endPos){var s=\"\";++endPos;for(var i=startPos;i<endPos;++i){if(ar[i]){s+=ar[i];}}\nreturn s;}\n_$proto._pushLiterals=function(ar,startPos,endPos){this._LITERALS[this._LITERALS.length]=this._convertArrayPortionToString(ar,startPos,endPos);ar[startPos]=\"\\u1000\";this._markDeleteElems(ar,startPos+1,endPos);}",
"js.build.Packager" : "$package(\"js.build\");$import(\"js.build.Compressor\");js.build.Packager=function(mode){this._mode=0;this._names=[];this._files=[];this._isCompress=false;this._localeLang=\"\";this._Packager(mode);}\nvar _$class=js.build.Packager;_$class.$extends(\"Object\");var _$proto=js.build.Packager.prototype;_$class.MODE={FILE:0,CLASS:1,TEMPLATE:2,RESOURCE:3,PRODUCT:4}\n_$proto._Packager=function(mode){this._mode=mode;}\n_$proto.getMode=function(){return this._mode;}\n_$proto.setMode=function(value){if(value===this._mode)return;this._mode=value;this.fireEvent(\"_onModeChange\");}\n_$proto.getIsCompress=function(){return this._isCompress;}\n_$proto.setIsCompress=function(value){this._isCompress=value;}\n_$proto.getLocaleLang=function(){return this._localeLang;}\n_$proto.setLocaleLang=function(value){this._localeLang=value;}\n_$proto.addFile=function(sFilePath){this._files[this._files.length]=sFilePath;}\n_$proto.addFolder=function(){var fso=new ActiveXObject(\"Scripting.FileSystemObject\");}\n_$proto.addClasses=function(sClassFullName){var jsre=Engine.runtimeEnvironment;this._names[this._names.length]=sClassFullName;this._files[this._files.length]=\"classes/\"+sClassFullName.replace(/\\./g,\"/\")+Global.get(jsre.getRootHome()+\"/config.json\",\"\",false,\"\",\"JSON\")[\"file-extension\"][\"class\"].compile;}\n_$proto.clearEmpty=function(){this._names=[];this._files=[];}\n_$proto.build=function(sComment,oInfo,vSepa,sOutput){switch(this._mode){case 0:return this._buildForFile(sComment,vSepa,sOutput);case 1:return this._buildForClass(sComment,oInfo,sOutput);case 2:return;case 3:return this._buildForResource(sComment,oInfo,sOutput);case 4:return this._buildForProduct(sComment,sOutput);}\nreturn;}\n_$proto._buildForFile=function(sComment,vSepa,sOutput){if(!this._files.length)return;var jsre=Engine.runtimeEnvironment;var sSepa=\"\",sHeader=\"\",sFooter=\"\";var compressor=new Global.Compressor(1);var location=jsre.config.getParameter(\"location\");if(typeof(vSepa)==\"string\"){sSepa=vSepa;}else if(Global.isArray(vSepa)){if(vSepa.length==1){sSepa=vSepa[0];}else if(vSepa.length==2){sHeader=vSepa[0],sFooter=vSepa[1];}else if(vSepa.length==3){sHeader=vSepa[0],sSepa=vSepa[1],sFooter=vSepa[2];}}\nsOutput=Global.getURIFullPath(jsre.getRootPath().slice(1).replace(/\\//g,\"\\\\\"),sOutput,\"\\\\\");var sCode=\"\";var oEvent=document.createEventObject();var fso=new ActiveXObject(\"Scripting.FileSystemObject\");var file=fso.CreateTextFile(sOutput,true,false);if(!this._isCompress){file.WriteLine(sComment);if(sHeader)file.WriteLine(sHeader);for(var i=0,iLen=this._files.length;i<iLen;i++){var sFile=Global.getURIFullPath(jsre.getRootPath(),this._files[i].replace(/\\\\/g,\"/\"));if(!location.hostname){sFile=location.protocol+\"//\"+sFile;}\nvar errors=[];try{oEvent.result={filePath:sFile};this.fireEvent(\"_onPackagingFile\",oEvent);try{sCode=Global.get(sFile,\"\",false,\"\",\"Text\");sCode=Global.obj(sCode).encodeNonAscii();}catch(e){errors[errors.length]=e;sCode=\"\";}\nfile.Write(sCode);if(errors.length==0&&(i<iLen-1)){file.WriteLine(sSepa||\"\");file.WriteLine(\"\");}}catch(e){errors[errors.length]=e;}\nif(errors.length){oEvent.result={filePath:sFile,errors:errors};this.fireEvent(\"_onPackageFileFail\",oEvent);}}\nfile.WriteLine(\"\");if(sFooter)file.WriteLine(sFooter);}else{var text=\"\";text+=sComment+Global.STR_NewLine+sHeader;for(var i=0,iLen=this._files.length;i<iLen;i++){var sFile=Global.getURIFullPath(jsre.getRootPath(),this._files[i].replace(/\\\\/g,\"/\"));if(!location.hostname){sFile=location.protocol+\"//\"+sFile;}\nvar errors=[];try{oEvent.result={filePath:sFile};this.fireEvent(\"_onPackagingFile\",oEvent);try{sCode=Global.get(sFile,\"\",false,\"\",\"Text\");sCode=Global.obj(sCode).encodeNonAscii();}catch(e){errors[errors.length]=e;sCode=\"\";}\ntext+=sCode+Global.STR_NewLine;if(errors.length==0&&(i<iLen-1)){text+=(sSepa||\"\")+Global.STR_NewLine+Global.STR_NewLine;}}catch(e){errors[errors.length]=e;}\nif(errors.length){oEvent.result={filePath:sFile,errors:errors};this.fireEvent(\"_onPackageFileFail\",oEvent);}}\ntext+=sFooter;file.Write(compressor.compress(text));}\nfile.Close();oEvent.result={output:sOutput};this.fireEvent(\"_onCompleted\",oEvent);return;}\n_$proto._buildForClass=function(sComment,oManifest,sOutput){if(!this._files.length)return;var jsre=Engine.runtimeEnvironment;var compressor=new Global.Compressor(0);var location=jsre.config.getParameter(\"location\");sOutput=Global.getURIFullPath(jsre.getRootPath().slice(1).replace(/\\//g,\"\\\\\"),sOutput,\"\\\\\");var sCode=\"\";var sExtName=Global.get(jsre.getRootHome()+\"/config.json\",\"\",false,\"\",\"JSON\")[\"file-extension\"][\"class\"].compile;var oEvent=document.createEventObject();var fso=new ActiveXObject(\"Scripting.FileSystemObject\");var file=fso.CreateTextFile(sOutput,true,false);file.WriteLine(sComment);file.WriteLine(\"{\");file.WriteLine(\"manifest : {\");var aTemps=[];for(var p in oManifest){if(oManifest.hasOwnProperty(p)){aTemps[aTemps.length]=(\"\\\"\"+p+\"\\\" : \\\"\"+oManifest[p]+\"\\\"\");}}\nfile.WriteLine(aTemps.join(\",\"));file.WriteLine(\"},\");file.WriteLine(\"entity : {\");for(var i=0,iLen=this._names.length;i<iLen;i++){var aFiles=[this._names[i]];var aLangs=[\"\"];var sFile=\"\",sLang=\"\";if(this._localeLang){aFiles.insert(this._names[i]+\"_\"+this._localeLang,0);aLangs.insert(this._localeLang,0);}\naFiles=aFiles.map(function(item){var sFile=Global.getURIFullPath(jsre.getRootPath(),\"classes/\"+item.replace(/\\./g,\"/\")+sExtName);if(!location.hostname){sFile=location.protocol+\"//\"+sFile;}\nreturn sFile;});oEvent.result={fullName:this._names[i]};this.fireEvent(\"_onPackagingClass\",oEvent);var errors=[];try{for(var j=0;j<aFiles.length;j++){var sFile1=aFiles[j];var sLang1=aLangs[j];oEvent.result={fullName:this._names[i],filePath:sFile1};this.fireEvent(\"_onPackagingClassFile\",oEvent);try{sCode=Global.get(sFile1,\"\",false,\"\",\"Text\");}catch(e){sCode=\"\";oEvent.result={fullName:this._names[i],filePath:sFile1,error:e};this.fireEvent(\"_onPackageClassFileFail\",oEvent);}\nif(sCode!=\"\"){sFile=sFile1;sLang=sLang1;break;}}\nfile.Write(\"\\\"\"+this._names[i]+\"\\\" : \"+Global.obj(compressor.compress(sCode)).serialize());if(errors.length==0){file.WriteLine((i<iLen-1)?\",\":\"\");}}catch(e){errors[errors.length]=e;}\nif(sCode!=\"\"){oEvent.result={fullName:this._names[i],filePath:sFile,lang:sLang};this.fireEvent(\"_onPackageClassSuccess\",oEvent);}else if(sCode==\"\"){oEvent.result={fullName:this._names[i],errors:errors};this.fireEvent(\"_onPackageClassFail\",oEvent);}else if(errors.length){oEvent.result={fullName:this._names[i],errors:errors};this.fireEvent(\"_onPackageClassError\",oEvent);}}\nfile.WriteLine(\"}\");file.WriteLine(\"}\");file.Close();oEvent.result={output:sOutput};this.fireEvent(\"_onCompleted\",oEvent);return;}\n_$proto._buildForResource=function(sComment,oManifest,sOutput){if(!this._files.length)return;var jsre=Engine.runtimeEnvironment;var compressor=new Global.Compressor(1);var location=jsre.config.getParameter(\"location\");sOutput=Global.getURIFullPath(jsre.getRootPath().slice(1).replace(/\\//g,\"\\\\\"),sOutput,\"\\\\\");var sCode=\"\";var oEvent=document.createEventObject();var fso=new ActiveXObject(\"Scripting.FileSystemObject\");var file=fso.CreateTextFile(sOutput,true,false);file.WriteLine(sComment);file.WriteLine(\"_$JSDK3Loader$_&&_$JSDK3Loader$_.loadResource({\");file.Write(\"manifest : {\");var aTemps=[];for(var p in oManifest){if(oManifest.hasOwnProperty(p)){aTemps[aTemps.length]=(\"\\\"\"+p+\"\\\" : \\\"\"+oManifest[p]+\"\\\"\");}}\nfile.Write(aTemps.join(\",\"));file.WriteLine(\"},\");file.WriteLine(\"entity : {\");for(var i=0,iLen=this._files.length;i<iLen;i++){sCode=\"\";var sExtName=this._files[i].rightBack(\".\").toLowerCase();var sFile=Global.getURIFullPath(jsre.getRootPath(),this._files[i]);var sMinFile=sExtName==\"js\"?Global.getURIFullPath(jsre.getRootPath(),\"min/\"+this._files[i]):\"\";if(!location.hostname){sFile=location.protocol+\"//\"+sFile;sMinFile=sMinFile?(location.protocol+\"//\"+sMinFile):\"\";}\noEvent.result={filePath:this._files[i]};this.fireEvent(\"_onPackagingResFile\",oEvent);var errors=[];try{if(sMinFile){sCode=Global.get(sMinFile,\"\",false,\"\",\"Text\");}\nif(!sCode){sCode=Global.get(sFile,\"\",false,\"\",\"Text\");}\nif(!this._isCompress){if(sExtName!=\"json\"){file.Write(\"\\\"\"+this._files[i]+\"\\\" : \"+Global.obj(sCode).serialize());}else{file.Write(\"\\\"\"+this._files[i]+\"\\\" : \"+sCode);}}else{if(sExtName!=\"json\"){file.Write(\"\\\"\"+this._files[i]+\"\\\" : \"+Global.obj(compressor.compress(sCode)).serialize());}else{file.Write(\"\\\"\"+this._files[i]+\"\\\" : \"+compressor.compress(sCode));}}\nif(errors.length==0){file.WriteLine((i<iLen-1)?\",\":\"\");}}catch(e){errors[errors.length]=e;}\nif(sCode!=\"\"){oEvent.result={filePath:this._files[i]};this.fireEvent(\"_onPackageResFileSuccess\",oEvent);}else if(sCode==\"\"){oEvent.result={filePath:this._files[i],errors:errors};this.fireEvent(\"_onPackageResFileFail\",oEvent);}else if(errors.length){oEvent.result={filePath:this._files[i],errors:errors};this.fireEvent(\"_onPackageResFileError\",oEvent);}}\nfile.WriteLine(\"}\");file.WriteLine(\"});\");file.Close();oEvent.result={output:sOutput};this.fireEvent(\"_onCompleted\",oEvent);return;}\n_$proto._buildForProduct=function(sComment,sOutput){}\n_$proto.attachEvent=function(sEvent,fpNotify){switch(sEvent){case\"onPackagingFile\":case\"onPackageFileError\":case\"onPackageFileFail\":case\"onPackageFileSuccess\":case\"onPackagingClass\":case\"onPackagingClassFile\":case\"onPackageClassError\":case\"onPackageClassFileFail\":case\"onPackageClassFail\":case\"onPackageClassSuccess\":case\"onPackagingResFile\":case\"onPackageResFileError\":case\"onPackageResFileFail\":case\"onPackageResFileSuccess\":case\"onCompleted\":this[sEvent]=fpNotify;break;default:}}\n_$proto._onModeChange=function(){this._files=[];}\n_$proto._onPackagingFile=function(oEvent){this.fireEvent(\"onPackagingFile\",oEvent);}\n_$proto._onPackageFileError=function(oEvent){this.fireEvent(\"onPackageFileError\",oEvent);}\n_$proto._onPackageFileFail=function(oEvent){this.fireEvent(\"onPackageFileFail\",oEvent);}\n_$proto._onPackagingClass=function(oEvent){this.fireEvent(\"onPackagingClass\",oEvent);}\n_$proto._onPackagingClassFile=function(oEvent){this.fireEvent(\"onPackagingClassFile\",oEvent);}\n_$proto._onPackageClassError=function(oEvent){this.fireEvent(\"onPackageClassError\",oEvent);}\n_$proto._onPackageClassFileFail=function(oEvent){this.fireEvent(\"onPackageClassFileFail\",oEvent);}\n_$proto._onPackageClassFail=function(oEvent){this.fireEvent(\"onPackageClassFail\",oEvent);}\n_$proto._onPackageClassSuccess=function(oEvent){this.fireEvent(\"onPackageClassSuccess\",oEvent);}\n_$proto._onPackagingResFile=function(oEvent){this.fireEvent(\"onPackagingResFile\",oEvent);}\n_$proto._onPackageResFileError=function(oEvent){this.fireEvent(\"onPackageResFileError\",oEvent);}\n_$proto._onPackageResFileFail=function(oEvent){this.fireEvent(\"onPackageResFileFail\",oEvent);}\n_$proto._onPackageResFileSuccess=function(oEvent){this.fireEvent(\"onPackageResFileSuccess\",oEvent);}\n_$proto._onCompleted=function(oEvent){this.fireEvent(\"onCompleted\",oEvent);}"
}
}
